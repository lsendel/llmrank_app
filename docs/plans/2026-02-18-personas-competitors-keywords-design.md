# Design: Auto-Suggested Personas, Competitor Discovery & Keyword Persistence

**Date:** 2026-02-18
**Status:** Approved

## Context

LLM Boost currently has visibility checks across 7 AI providers with competitor mention tracking, but:

- Competitors must be added manually (Pro+ only, no auto-discovery)
- Personas exist only as a generation endpoint (`POST /strategy/:projectId/personas`) — results are not persisted
- Keyword discovery (`POST /visibility/:projectId/discover-keywords`) returns results but doesn't save them
- No persona-driven prompt generation for visibility tracking
- No competitor benchmarking comparison view

Modern GEO platforms (Conductor, Profound, Otterly, Scrunch) treat personas as prompt-generation engines and auto-discover competitors from AI responses. This design brings LLM Boost to parity.

## Approach: Smart Onboarding Pipeline

After a crawl completes, automatically:

1. Extract site signals (title, meta description, OG tags, structured data)
2. Discover competitors via Perplexity Sonar API
3. Generate personas + keywords via Anthropic Haiku
4. Save everything to DB
5. Present suggestions to user for confirmation/editing

Cost: ~$0.01 per project setup (one Sonar call + one Haiku call).

---

## 1. Data Model

### New table: `personas`

| Column           | Type                | Description                                   |
| ---------------- | ------------------- | --------------------------------------------- |
| id               | uuid PK             | defaultRandom()                               |
| projectId        | uuid FK -> projects |                                               |
| name             | text                | Display name, e.g. "Marketing Director"       |
| role             | text                | Job title / function                          |
| jobToBeDone      | text                | Primary search objective                      |
| constraints      | text                | Time, budget, compliance limitations          |
| successMetrics   | text                | How they judge a "good" answer                |
| decisionCriteria | text                | What proof they need before acting            |
| vocabulary       | text[]              | Natural language patterns/phrases             |
| sampleQueries    | text[]              | 5-10 queries this persona would ask           |
| funnelStage      | enum                | education / comparison / purchase             |
| avatarUrl        | text                | R2 URL to avatar image                        |
| isAutoGenerated  | boolean             | true = system-suggested, false = user-created |
| createdAt        | timestamp           | defaultNow()                                  |

### New table: `saved_keywords`

| Column         | Type                           | Description                               |
| -------------- | ------------------------------ | ----------------------------------------- |
| id             | uuid PK                        | defaultRandom()                           |
| projectId      | uuid FK -> projects            |                                           |
| keyword        | text                           | The discovered keyword/phrase             |
| source         | enum                           | auto_discovered / user_added / perplexity |
| relevanceScore | real                           | 0-1 confidence score                      |
| funnelStage    | enum                           | education / comparison / purchase         |
| personaId      | uuid FK -> personas (nullable) | Which persona this maps to                |
| createdAt      | timestamp                      | defaultNow()                              |

### New enum: `funnel_stage`

Values: `education`, `comparison`, `purchase`

### New enum: `keyword_source`

Values: `auto_discovered`, `user_added`, `perplexity`

### Modified table: `competitors`

Add column: `source text DEFAULT 'user_added'` — values: `auto_discovered` or `user_added`

### Plan Limits

| Resource              | Free                          | Starter | Pro     | Agency    |
| --------------------- | ----------------------------- | ------- | ------- | --------- |
| Personas              | 2 (read-only, auto-suggested) | 5       | 15      | Unlimited |
| Competitors           | 3 (read-only, auto-suggested) | 5       | 10      | 25        |
| Keywords              | 10 (read-only)                | 50      | 200     | Unlimited |
| Custom avatar gen     | No                            | No      | 5/month | Unlimited |
| AI persona refinement | No                            | Yes     | Yes     | Yes       |

---

## 2. Auto-Discovery Pipeline

### Trigger

- After first crawl completes (automatic)
- On-demand from dashboard ("Re-discover" button)

### Step 1: Extract Site Signals

From crawl data already in DB (index page):

- `<title>`, `<meta name="description">`, OG tags
- Organization schema (if present) for industry classification
- Brand name from domain + title parsing

### Step 2: Competitor Discovery (Perplexity Sonar)

```
Prompt: "What are the top alternatives and competitors to {brand} ({domain})?
         {brand} is a {meta_description}.
         List the top 5-8 competing products/services with their domain names."
```

- Parse response for domain names
- Save to `competitors` table with `source='auto_discovered'`
- Model: Sonar (not Pro, to keep costs minimal)

### Step 3: Persona + Keyword Generation (Anthropic Haiku)

```
Prompt: "Given this website:
         Domain: {domain}, Title: {title}, Description: {meta_description}

         Generate 3-5 audience personas who would search for this type of
         product/service in AI search engines. For each:
         name, role, jobToBeDone, constraints, successMetrics,
         decisionCriteria, vocabulary[], sampleQueries[], funnelStage

         Also generate 10-15 relevant search keywords/queries with
         funnelStage and relevanceScore (0-1).

         Return as JSON."
```

- Parse structured JSON response
- Save personas to `personas` table with `isAutoGenerated=true`
- Save keywords to `saved_keywords` table with `source='auto_discovered'`
- Link keywords to personas where applicable

### Step 4: Avatar Generation

- Generate DiceBear "personas" style SVG for each persona (seed = persona name)
- Upload to R2 at `avatars/{projectId}/{personaId}.svg`
- Store URL in `personas.avatarUrl`

### Step 5: Present to User

- **Onboarding:** New step after crawl completes showing suggestions
- **Dashboard:** "Suggestions" card on project overview page

---

## 3. AI-Assisted Persona Refinement

### Generate Mode (new persona)

1. User enters a role name (e.g., "VP of Engineering")
2. API calls Anthropic Haiku with site context + role name
3. Returns complete persona card (all fields populated)
4. User reviews, edits any field, saves

### Refine Mode (editing existing persona)

1. User modifies a field and saves
2. API sends full persona + changed field context to Anthropic
3. AI suggests improvements for related fields
4. Suggestions appear as inline accept/reject chips in the UI

### Custom Avatar Generation (Pro+ only)

- Cloudflare Workers AI with `@cf/black-forest-labs/flux-1-schnell`
- Prompt: `"Professional headshot illustration of a {role}, {industry} professional, clean minimal style, white background"`
- Result saved to R2, URL stored in `personas.avatarUrl`
- Pro: 5 custom avatars/month; Agency: unlimited

### Generic Avatar Set

- Pre-generate ~15 common role avatars at deploy time using DiceBear
- Store in R2 at `avatars/generic/{role-slug}.svg`
- Reuse across all customers as defaults

---

## 4. Competitor Benchmark View

### Location: Dashboard -> Benchmark tab (or section within Visibility tab)

### Layout

- **Top bar:** "Add Competitor" button + competitor count vs. plan limit
- **Comparison table:** User's site + all tracked competitors as columns

| Metric                | yoursite.com  | competitor1.com | competitor2.com |
| --------------------- | ------------- | --------------- | --------------- |
| AI Visibility Score   | 78            | 85              | 62              |
| Share of Voice        | 32%           | 45%             | 23%             |
| Brand Mentioned (avg) | 4/7 providers | 6/7             | 3/7             |
| URL Cited (avg)       | 2/7           | 5/7             | 1/7             |
| Letter Grade          | B             | A               | D               |

### Actions per Competitor

- **Delete:** Trash icon, removes from tracking
- **Run Search:** Triggers visibility check on competitor's content
- **Confirmation dialog:** "This will run a visibility check for {competitor} across {n} providers. This counts against your monthly checks. Proceed?"

### Persona/Keyword Filtering

- Filter benchmark results by persona or keyword
- Shows: "How does {competitor} rank when {persona} searches for {keyword}?"

---

## 5. Keyword Persistence

### Current Gap

`POST /visibility/:projectId/discover-keywords` returns keywords but doesn't save.

### Solution

- Auto-save discovered keywords to `saved_keywords` table
- New API endpoints:
  - `GET /api/keywords/:projectId` — list saved keywords
  - `POST /api/keywords/:projectId` — add keyword manually
  - `DELETE /api/keywords/:id` — remove keyword
- Dashboard shows saved keywords with add/remove capability
- Keywords link to personas (optional) and funnel stages
- Visibility checks can be run against saved keywords

---

## 6. API Routes (New/Modified)

### New Routes

```
# Personas
GET    /api/personas/:projectId         — list personas
POST   /api/personas/:projectId         — create persona (manual or AI-generated)
PATCH  /api/personas/:id                — update persona
DELETE /api/personas/:id                — delete persona
POST   /api/personas/:id/refine         — AI refinement suggestions
POST   /api/personas/:id/avatar         — generate custom avatar (Pro+)

# Keywords
GET    /api/keywords/:projectId         — list saved keywords
POST   /api/keywords/:projectId         — add keyword(s)
DELETE /api/keywords/:id                — delete keyword

# Discovery Pipeline
POST   /api/discovery/:projectId/run    — trigger full auto-discovery pipeline
GET    /api/discovery/:projectId/status — check discovery pipeline status

# Competitors (existing, extended)
GET    /api/strategy/:projectId/competitors    — (exists) list competitors
POST   /api/strategy/:projectId/competitors    — (exists) add competitor
DELETE /api/strategy/competitors/:id           — (exists) remove competitor
GET    /api/competitors/benchmark              — (exists, enhanced) comparison table data
```

### Modified Routes

- `POST /visibility/:projectId/discover-keywords` — now saves results to `saved_keywords`
- `POST /competitors/benchmark` — enhanced to return comparison table format

---

## 7. UI Changes

### Onboarding Flow (new step after crawl)

- Show auto-discovered personas with avatars (confirm/dismiss each)
- Show auto-discovered competitors (confirm/dismiss each)
- Show suggested keywords grouped by funnel stage
- "Skip for now" option (suggestions saved but not active)

### Dashboard — Project Overview

- "Suggested for you" card if unreviewed suggestions exist
- Quick stats: X personas, Y competitors, Z keywords tracked

### Dashboard — Personas Section (new)

- Grid/list of persona cards with avatars
- Each card: name, role, funnel stage, sample queries count
- Click to expand/edit with AI refinement
- "Add Persona" button (role name input -> AI generates card)
- "Generate Avatar" button on card (Pro+)

### Dashboard — Benchmark Section (new or enhanced)

- Comparison table (see Section 4)
- Add/remove competitors
- Run search confirmation flow

### Dashboard — Keywords Section (new)

- List of saved keywords with funnel stage badges
- Add/remove keywords
- Link keywords to personas
- "Discover More" button triggers keyword discovery

---

## 8. Avatar Strategy

### Tier 1: DiceBear (default, $0)

- "personas" style SVGs generated from seed strings
- Deterministic: same name = same avatar
- Pre-generate ~15 generic roles, store in R2 shared prefix
- Used for all free/starter personas and as fallback

### Tier 2: Cloudflare Workers AI (Pro+)

- `@cf/black-forest-labs/flux-1-schnell` model
- First 10K neurons/day free, then very cheap
- Generate professional headshot illustrations on demand
- Cache in R2, never regenerate same persona twice
- Pro: 5 custom/month, Agency: unlimited

---

## Implementation Priority

1. **Data model** — new tables + schema push
2. **Discovery pipeline** — Perplexity + Anthropic calls, persistence
3. **Keyword persistence** — fix the existing gap
4. **Personas CRUD API** — endpoints + AI generation/refinement
5. **Competitor benchmark API** — enhanced comparison data
6. **Onboarding UI** — suggestion step after crawl
7. **Dashboard UI** — personas, keywords, benchmark sections
8. **Avatar generation** — DiceBear defaults + Workers AI custom
